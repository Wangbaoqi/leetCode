---
title: NetworkLayer of Network
excerpt: 网络层解决的是两个主机在不同的网络中如何通信的问题。关注的是如何将IP数据报从源主机沿着网络发送到目标主机。
type: Post
coverImage: 'https://media.wangbaoqi.tech/assets/blog/react/cover/api.webp'
date: '2022-02-10'
author: NateWang
authorIcon: 'https://media.wangbaoqi.tech/assets/authors/logo.png'
tags:
  - Network
category: Network
---

>不同的网络有不同的网络层协议和地址规范，如果不能理解另一个网络的协议和规范，则就不能与其进行通信。

网络通信的两种方式，**局域网（MAC地址寻址）** 和 **不同网络（IP地址）**

网络层向上只提供简单灵活的、无连接的、**尽最大努力交付**（虽然并不表示路由器可以任意丢弃分组，但在网络层上的这种交付实质上就是不可靠交付）的数据报服务。



## 虚拟的互联网络

我们知道，在实际中所有的网络都是连接到一起的，而这些网络都不尽相同（根据不同的需求划分为不同的网络），其连接是非常复杂的，而连接这些网络中间设备有以下几种：

1. 转发器：物理层使用的
2. 网桥和桥接器：数据链路层使用的
3. 路由器：网络层使用的
4. 网关：网络层以上使用的，用网关连接两个互不兼容的系统需要在高层进行协议转换

当中间设备是转发器或网桥时，这仅仅是把一个网络扩大了，而从网络层的角度看， 这仍然是 一个网络， 一般并不称之为网络互连。网关由于比较复杂，目前使用得较少。因此在讨论网络互连时，都是指用路由器进行网络互连和路由选择。**路由器其实就是一台专用计算机**，用来在互联网中进行路由选择。

而多个计算机通过路由器连接，且这些计算机使用相同的网际协议IP，因此可以把互连的计算机网络可以看成 **虚拟互联网络**。

所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络在网络层上看起来好像是一个统一的网络。

而如果在这种虚拟网络（可简称为IP网）上层使用TCP协议，那就是现在的 **互联网**。

## 网络的主要作用


1. 屏蔽网络差异, 提供透明传输

网络层能够解决不同网络之间的通信，使用统一网络通信的规范，使的 **传输层** 就可以在不同网络之间透明传输数据了。

网络层向传输层提供的服务：

- 面向连接的网络服务：虚电路服务
- 无连接的网络服务：数据包服务

2. 网络间通信提供路由选择

根据一定的原则和路由算法在多个节点的通信子网中选择一条到达目的节点的最佳路径

3. 数据包的封装和解封装

对来自传输层的报文的头部添加网络层协议控制信息封装成数据包，数据包的头部包含源节点和目标节点的网络层地址(IP地址)

数据从底层（数据链路层等）到达网络层时，要去掉数据链路层加上的协议信息（帧头和帧尾），还原出原本的数据包格式

4. 拥塞控制

**避免网络传输路径中数据的传输延迟或死锁**

在数据链路层提到了**流量控制功能**，那是针对**数据链路中点对点传输速率的控制**

而这里的拥塞控制是针对在**网络传输路径中的端到端传输效率的控制**（如避免路由器缓存空间爆满而造成丢包的情况）。


## 网际协议IP

互联网协议旨在用于分组交换计算机通信网络的互联系统。

<Intro>

IP网际协议是将多个分组交换网络连接起来的典型的通信协议。

该协议是无连接的服务，其提供将称为数据报的数据块从源传输到目的地，其中源和目的地是由固定长度地址标识的主机。如有必要，互联网协议还规定了长数据报的碎片化和重新组装，以便通过“小数据包”网络进行传输。

</Intro>

### 主要功能

将数据报在一个个IP模块（路由器或者网关）间传送到目的主机，在模块间通过路由处理网络地址传送到目的主机。
在整个过程中，有以下的过程：

1. 寻址

在局部的以太网中，结点之间的寻址可以使用 **Mac地址来** 进行，但是在不同的网络中，寻址则只能通过 **IP地址**来寻址。

2. 数据报的封装

从传输层到达的数据报都是需要经过IP协议重新进行封装的，因为IP协议是无连接的服务，并且采用数据报交换方式，所以封装后形成的是IP数据报。

IP封装的目的就是标识此IP数据报发送节点和接收节点的IP地址及控制信息。

3. 分段与重组


### IP地址

在TCP/IP体系中，IP地址是最基本的概念，其重要的正式规范文档在[RFC 791]()

**IP地址**是由[ICANN]()给互联网上的每一台主机或者路由器分配的唯一的一个 **32位标识符**，以便在互联网上进行寻址。

IP地址的编址有以下三种：

- 分类的IP地址
- 子网的划分
- 构成超网

#### 分类的IP地址

分类的IP地址就是讲IP地址分为多个类别，目前有 **5个类别**，每一类地址都由两个固定长度的字段组成- **网络号+主机号**。

**网络号**：标志主机或者路由器连接到的网络。
**主机号**：标志主机或者路由器。

这种两级的IP地址的可以记为

```
IP地址 ::=  {<网络号>，<主机号>}
```

下图是各个分类IP地址的 **网络号** 和 **主机号**

![](https://media.wangbaoqi.tech/assets/blog/network/networkLayer/ip_class.png)


- A类、B类和C类地址的网络号字段 (在图中这个字段是灰色的)分别为1 个、2 个 和 3 个字节长，而在网络号字段的最前面有 1~3 位的类别位，其数值分别规定为 0， 10 和 110。
- A 类、B 类和 C 类地址的主机 号字段分别为了个、2 个和 1 个字节长。
- D 类 地 址 ( 前 4 位 是 1 1 1 0 ) 用 于 多 播 ( 一对 多 通 信 ) 。 我 们 将 在 4 6 节 讨 论 卫 多 播 。
- E类地址 (前4 位是 1111)保留为以后用。

<Note>

把IP地址划分为A类、B类、C 类三个类别，当初是这样考虑的。各种网络的差异很大 ， 有的网络拥有很多主机，而有的网络上的主机则很少。把IP地址划分为 A 类 、 B 类 和C类是为了更好地满足不同用户的要求。当某个单位申请到一个 IP 地址时，实际上是获得 了具有同样网络号的一块地址。其中具体的各台主机号则由该单位自行分配，只要做到在该单位管辖的范围内无重复的主机号即可。

</Note>

**点分十进制**：是为了方便可读性，在IP地址中每8位插入一个点。

**A、B、C类IP的指派范围**

| 网络类别 | 最大指派网络数    | 第一个指派网络号 | 最后一个指派网络号 | 每个网络中最大主机数 |
| -------- | ----------------- | ---------------- | ------------------ | -------------------- |
| A        | 126(2^7 - 2)      | 1                | 126                | 16777214             |
| B        | 16383（2^14 - 1） | 128.1            | 191.255            | 65534                |
| C        | 2087151(2^21 - 1) | 192.0.1          | 223.255.255        | 254                  |


IP地址具有以下特点：

1. 每一个IP地址都由 **网络号** 和 **主机号** 组成，这样做的好处有两个
  - IP地址管理机构分配IP地址时只分配网络号，而主机号则由该网络号的单位自行分配，方便了IP地址的管理
  - 路由器仅根据**目的主机所连接的网络号**来转发分组，减少了路由表中的项目数，减少了路由表占用的空间和查找路由表的时间。
2. IP地址是标志一台主机（路由器）和一条链路的接口
3. 一个网络是指 **具有相同的网络号**的主机的集合，因此用转发器和网桥连接的若干个局域网仍为一个网络。

### IP地址和MAC地址

**从层次角度来看**，IP地址是 **网络层及以上各层使用的地址**，MAC地址是 **数据链路层和物理层使用的地址**。

发送数据时，数据从上到下层，然后猜到数据链路上传输，使用IP地址的IP数据报一旦传输到数据链路层，就被 **封装成帧**了，MAC帧在发送和传输的时候使用的 **源地址和目的地址**都是硬件地址。

### 地址解析协议ARP

**ARP就是我们已知主机或者路由器的IP地址，需要找到其响应的MAC地址而产生的**。

其功能就是

```shell
MAC address = ARP(IP address)
```

与其对应的一个协议有 **RARP，其功能与ARP相反，通过MAC地址找到对应的IP地址**，现在的 **DHCP协议已经包含了其功能**。

**ARP协议查找MAC地址的方式是在每一个主机ARP高速缓存中存放一个从IP地址到MAC地址的映射表，此映射表经常会更新**。


### IP层转发分组的流程

如下图，三个路由器连接了四个不同的网络，如果**源主机A**传输数据到**目的主机B**，要在这几个网络中进行，那么传输转发的流程如下：

![ip-forwarding-grouping](https://media.wangbaoqi.tech/assets/blog/network/networkLayer/ip-forwarding-grouping.png)

每个路由器都有一个路由表，而路由表存储的信息是 **目的主机所在的网络** 到 **下一跳地址** 的映射。

由于在源主机中可以知道目的主机的IP地址，所以也就知道了目的主机的网络，在不同的路由器之间转发时，如果遇到目的主机所在的网络，则开始进行跳转。